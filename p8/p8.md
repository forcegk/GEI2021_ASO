# Práctica 8 - ASO

## Copia de seguridad con shell script
```bash
#!/bin/sh

set -e

BACKUP_DIR="/var/backups"
BACKUP_LIM=10
BACKUP_LOG=YES
BACKUP_LOG_PRIO="user.notice"
BACKUP_HOME_DIR="/home"

# Prefijos a excluir del backup
AWK_EXCLUDE_REGEX='!/^\/$|^\/var|^\/proc|^\/srv|^\/dev|^\/usr|^\/etc|^\/root$|^\/operator$|^\/nonexistent|^\/bin$|^\/sbin$/'

prepare_solaris() {
	# Yañez por qué nos haces esto
	if [ $(uname) = "SunOS" ]; then
		awk=/usr/xpg4/bin/awk
	else
		awk=awk
	fi
}

main() {
	prepare_solaris
	
	# Creamos carpeta si no existe
	mkdir -p $BACKUP_DIR
	chown root $BACKUP_DIR
	chmod 755 $BACKUP_DIR

	# Creamos el archivador con magia negra y solaris
	du -ks $(getent passwd | cut -d":" -f6 | awk $AWK_EXCLUDE_REGEX) | \
	$awk 'function basename(dir) { sub(".*/", "", dir); return dir;} $1 >= blim {print $2, basename($2)}' blim="$BACKUP_LIM" | \
	xargs -L1 sh -c 'tar -cf - -C $0/.. $1 | gzip -c9 > /var/backups/$1.tar.gz && chown $1 /var/backups/$1.tar.gz && chmod 400 /var/backups/$1.tar.gz'
}

# Si activamos el log, redirigimos stdin y stderr a logger
if [ "$BACKUP_LOG" = "YES" ]; then
	main 2>&1 | logger -p $BACKUP_LOG_PRIO
else
	main
fi

```

Automatizar copias de seguridad 1 vez al día:

## Envío de logs

### Devuan

### Solaris 10

### OpenBSD 6.8

### FreeBSD

### Fedora

### Solaris 11

### Ubuntu