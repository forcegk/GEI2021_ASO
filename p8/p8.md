# Práctica 8 - ASO

## Copia de seguridad con shell script
```bash
#!/bin/sh

set -e

BACKUP_DIR="/var/backups"
BACKUP_LIM=10
BACKUP_LOG=YES
BACKUP_LOG_PRIO="user.notice"
BACKUP_HOME_DIR="/home"
BACKUP_COMPRESSION_LEVEL="9"

# Prefijos a excluir del backup RECORDAR ELIMINAR /HOME/ALONSO
AWK_EXCLUDE_REGEX='!/^\/$|^\/var|^\/proc|^\/srv|^\/dev|^\/usr|^\/etc|^\/root$|^\/operator$|^\/nonexistent|^\/bin$|^\/sbin$/'

compress_directory() {
	echo "$1: compress to $2"
	# tar
	#   -c: comprime
	#   -f: archivo destino - (stdout)
	#   -C: cambiar directorio raiz a $1
	#   *:  todos los archivos
	# gzip
	#   -c: comprimir con nivel especificado
	tar -cf - -C "$1" . | gzip -c"$BACKUP_COMPRESSION_LEVEL" > "$2"
}

main() {

	getent passwd | cut -d":" -f6 | awk $AWK_EXCLUDE_REGEX # | xargs -I {} sh -c 'tar -cf - {} | gzip -c9 > /home/alonso/backups/$(echo {} | rev | cut -d"/" -f1 | rev).tar.gz'

	# Comprueba si el directorio destino existe
	if [ ! -d "$BACKUP_DIR" ]; then
		echo "$BACKUP_DIR does not exist or is not a directory"
		return 1
	fi

	# Para el directorio home de cada usuario
	for f in "$BACKUP_HOME_DIR"/*
	do
		# Comprueba si es una carpeta
		if [ ! -d "$f" ]; then
			echo "$f: not a directory"
			# Salta al siguiente directorio
			continue
		fi
		
		# Comprueba el tamano
		DIR_SIZE=$(du -ks "$f" | cut -f1)
		# Si no alcanza el limite establecido, lo salta
		if [ $(("$DIR_SIZE")) -lt $(("$BACKUP_LIM")) ]; then
			echo "$f: directory smaller than minimum size"
			continue
		fi
		
		# Obtiene la ruta del archivo destino y comprime
		BASE_DIR=$(basename "$f")
		DEST="$BACKUP_DIR"/$BASE_DIR.tar.gz
		compress_directory "$f" "$DEST"
		# Establece permisos de lectura solo para el usuario
		# ASUMIMOS que el nombre del directorio es el mismo que el username
		chown "$BASE_DIR" "$DEST"
	done
}

# Si activamos el log, redirigimos stdin y stderr a logger
if [ "$BACKUP_LOG" = "YES" ]; then
	main 2>&1 | logger -p $BACKUP_LOG_PRIO
else
	main
fi

```

Automatizar copias de seguridad 1 vez al día:

## Envío de logs

### Devuan

### Solaris 10

### OpenBSD 6.8

### FreeBSD

### Fedora

### Solaris 11

### Ubuntu