# Práctica 8 - ASO

## Copia de seguridad con shell script
```bash
#!/bin/sh

set -e

# Directorio donde se almacenan las copias
BACKUP_DIR="/var/backups"

# Tamano minimo del directorio home para que se copie
BACKUP_LIM=10

# Envia mensajes al sistema de logs
BACKUP_LOG=YES

# Prioridad de los mensajes de log
BACKUP_LOG_PRIO="user.notice"

# Prefijos a excluir del backup
AWK_EXCLUDE_REGEX='!/^\/$|^\/var|^\/proc|^\/dev|^\/usr|^\/etc|^\/root$|^\/operator$|^\/nonexistent|^\/bin$|^\/sbin$|^\/run$/'

# TL;DR /, /usr*, /var*, /operator, /nonexistent, /bin, /dev, /proc, /sbin, /etc, /run

# getent passwd | cut -d: -f6 | uniq

# Solaris 10: /, /usr/bin, /var/adm, /usr/spool/lp, /usr/lib/uucp, /var/spool/uucppublic, /usr/net/nls

# OpenBSD: /, /operator, /var/empty, /var/unbound, /nonexistent

# Devuan: /root, /usr/sbin, /bin, /dev, /bin, /usr/games, /var/cache/man, /var/spool/lpd, /var/mail, /var/spool/news, /var/spool/uucp, /var/www, /var/backups, /var/list, /var/run/ircd, /var/lib/gnats, /nonexistent, /var/lib/usbmux, /proc, /var/run/pulse, /var/run/speech-dispatcher, /var/run/avahi-daemon, /var/lib/saned /var/run/vboxadd

# Fedora: /, /bin, /sbin, /var/adm, /var/spool/lpd, /sbin, /var/spool/mail, /usr/games, /var/ftp, /dev/null, /etc/unbound, /var/lib/geoclue, /proc, /var/run/pipewire, /var/run/avahi-daemon, /var/run/pulse, /etc/abrt, /var/run/sstpc, /var/lib/chrony, /var/lib/rpcbind, /var/lib/colord, /var/lib/setroubleshoot, /etc/openvpn, /var/lib/lightdm, /var/lib/nfs, /var/run/vboxadd, /var/empty/sshd, /var/lib/dnsmasq

# FreeBSD: /, /usr/share/man, /var/empty, /var/spool/clientmqueue, /var/unbound, /nonexistent, /var/spool/uucppublic, /var/db/ntp

# Solaris 11: /, /var/adm, /var/empty, /var/lib/gdm

# Ubuntu: /, /usr/sbin, /bin, /dev, /bin, /usr/games, /var/cache/man, /var/spool/lpd, /var/mail, /var/spool/news, /var/spool/uucp, /var/www, /var/backups, /var/list, /var/run/ircd, /var/lib/gnats, /nonexistent, /run/systemd, /home/syslog, /var/lib/tpm, /run/uuidd, /var/lib/landscape, /var/cache/pollinate, /var/snap/lxd/common/lxd, /proc, /var/lib/misc, /var/lib/usbmux, /var/run/avahi-daemon, /home/cups-pk-helper, /var/run/pulse, /var/lib/geoclue, /var/lib/saned, /var/lib/colord, /var/lib/gdm3, /var/run/vboxadd, /run/sshd

prepare_solaris() {
	# Yañez por qué nos haces esto
	if [ "`uname`" = "SunOS" ]; then
		awk=/usr/xpg4/bin/awk
	else
		awk=`which awk`
	fi
}

main() {
	prepare_solaris
	
	# Creamos carpeta si no existe
	mkdir -p $BACKUP_DIR
	chown root $BACKUP_DIR
	chmod 755 $BACKUP_DIR

	# Creamos el archivador con magia negra y solaris
	du -ks "`getent passwd | cut -d":" -f6 | awk $AWK_EXCLUDE_REGEX`" | \
	$awk 'function basename(dir) { sub(".*/", "", dir); return dir;} $1 >= blim {print $2, basename($2)}' blim="$BACKUP_LIM" | \
	xargs -L1 sh -c 'tar -cf - -C $0/.. $1 | gzip -c9 > /var/backups/$1.tar.gz && chown $1 /var/backups/$1.tar.gz && chmod 400 /var/backups/$1.tar.gz'
}

# Si activamos el log, redirigimos stdin y stderr a logger
if [ "$BACKUP_LOG" = "YES" ]; then
	main 2>&1 | logger -p $BACKUP_LOG_PRIO
else
	main
fi

```

Automatizar copias de seguridad 1 vez al día:

## Envío de logs

### Devuan

### Solaris 10

### OpenBSD 6.8

### FreeBSD

### Fedora

### Solaris 11

### Ubuntu