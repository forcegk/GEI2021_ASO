# Práctica 8 - ASO

## Copia de seguridad con shell script
```bash
#!/bin/sh

set -e

# Directorio donde se almacenan las copias
BACKUP_DIR="/var/backups"

# Tamano minimo del directorio home para que se copie
BACKUP_LIM=10

# Envia mensajes al sistema de logs
#BACKUP_LOG=YES
BACKUP_LOG=NO

# Prioridad de los mensajes de log
BACKUP_LOG_PRIO="user.notice"

# Nivel de compresion
BACKUP_COMPRESSION_LEVEL=9

# Prefijos a excluir del backup
AWK_EXCLUDE_REGEX='!/^.*:\/$|^.*:\/var|^.*:\/proc|^.*:\/dev|^.*:\/usr|^.*:\/etc|^.*:\/root$|^.*:\/operator$|^.*:\/nonexistent|^.*:\/bin$|^.*:\/sbin$|^.*:\/run/'

main() {

    # El awk que necesitamos en Solaris esta en otra ubicacion
    if [ "`uname`" = "SunOS" ]; then
        awk=/usr/xpg4/bin/awk
    else
        awk=`which awk`
    fi
    
    # Creamos carpeta si no existe
    mkdir -p $BACKUP_DIR
    chown root $BACKUP_DIR
    chmod 755 $BACKUP_DIR

    # username homedir sizekb
    #   $0 : username
    #   $1 : homedir

    # Creamos el archivador con magia negra para que funcione en solaris (de verdad, hemos estado bastante tiempo para hacer que esto funcione en todos los sistemas)
    getent passwd | cut -d":" -f1,6 | $awk $AWK_EXCLUDE_REGEX | \
    xargs -I {} sh -c 'echo "{}:`du -ks \`echo {} | cut -d":" -f2\` | cut -f 1`"' | \
    $awk -F'[:]' '$3 >= limit {print $1,$2}' limit="$BACKUP_LIM" | \
    xargs -L1 sh -c "tar -cf - -C \$1/.. \`basename \$1\` | \
                    gzip -c$BACKUP_COMPRESSION_LEVEL > $BACKUP_DIR/\$0.tar.gz && \
                    chown \$0 $BACKUP_DIR/\$0.tar.gz && \
                    chmod 400 $BACKUP_DIR/\$0.tar.gz && \
                    echo \"Backed up user \$0 at $BACKUP_DIR/\$0.tar.gz\""
}

# Si activamos el log, redirigimos stdin y stderr a logger
if [ "$BACKUP_LOG" = "YES" ]; then
    main 2>&1 | logger -p $BACKUP_LOG_PRIO
else
    main
fi
```

Automatizar copias de seguridad 1 vez al día:

## Envío de logs

### Devuan

### Solaris 10

### OpenBSD 6.8

### FreeBSD

### Fedora

### Solaris 11

### Ubuntu