# Practica 7 - ASO

## MAQUINA 1

### VirtualBox
Añadimos el disco a la máquina ASO1:
- Configuración
  - Almacenamiento
    - Controlador: IDE (o SATA) -> Agregar
      - Crear
        - Modo experto
          - Tamaño de archivo *1,00 GB*
          - Tipo de archivo de disco duro *VMDK (Virtual Machine Disk)*
          - Almacenamiento en disco duro *Reservado dinámicamente*
      - Seleccionamos *ASO1_1.vmdk*
      - Seleccionar
  - Aceptar

El resultado debería ser

![Dispositivos de almacenamiento en ASO2](./img/hdd_aso1.png)

Creamos la partición FAT desde *Devuan*.

Debido a que cada sistema operativo tiene un criterio diferente de formato y
alineación, puede existir espacio libre entre particiones. En la práctica 1,
decidimos instalar primero Solaris, que deja un espacio de 16064 sectores
desde el comienzo del disco hasta su partición.

Si utilizamos *fdisk*, y no especificamos nada en el inicio de la partición,
toma el primer espacio libre que encuentra. En nuestro caso, detecta este espacio
libre, por lo que es necesario especificar manualmente el lugar de inicio.
Para calcularlo, ejecutamos `fdisk -l`, y escogemos el valor de *end*+1 de la
última partición, siempre que estén ordenadas. Finalmente, formateamos y creamos
el sistema de fichero. Hemos automatizado este proceso entero en un script.

Alternativamente, podemos crear la partición desde *Solaris*, que la coloca
automáticamente en el espacio libre al final del disco. Hay que tener en cuenta
que quedará alineada al cilindro.

### Devuan
```bash
#!/bin/bash

set -e

create_fat_partition() {
    local DISK="$1"
    local MOUNT_POINT="$2"

    echo "Buscando espacio libre al final de $DISK"
    local PARTITION_ENDS=$(\
    `# Obtenemos las posiciones de las particiones con fdisk` \
    fdisk -l /dev/sda \
    `# Busca el header de fdisk y muestra las 10 lineas siguientes` \
    | grep -EA10 "^Device\s+Boot\s+Start\s+End\s+Sectors\s+Size\s+Id\s+Type$" \
    `# Elimina el header de fdisk` \
    | tail -n+2 \
    `# Elimina espacios y el asterisco de boot (para que coincidan las columnas)` \
    | tr -d '\*' | tr -s '[:blank:]' ' ' \
    `# Obtiene la tercera columna (end)` \
    | cut -d " " -f3 )

    # Obtiene el offset mayor (si hay particiones desordenadas)
    # Suma uno para obtener el primer sector libre
    local FREE_SPACE_SECTOR=$(echo "${PARTITION_ENDS[*]}"| sort -nr | head -n1)
    ((FREE_SPACE_SECTOR++))

    # Creamos particion en el espacio libre. Especificando 100% alinea automaticamente
    # con el criterio especificado (-a). Opciones: none, minimal, cylinder, optimal
    echo "Crear partición primaria fat32 en /dev/sda ${FREE_SPACE_SECTOR}s - 100%"
    parted -a optimal $DISK mkpart primary fat32 ${FREE_SPACE_SECTOR}s 100%

    # La particion nueva es la ultima
    FAT_PARTITION=$(fdisk -l $DISK `# Lista particiones disco`\
    | tail -n 1 `# Separa linea ultima particion`\
    | cut -d " " -f1 `# Escoge primera columna separada por espacio (/dev/sd..)`\
    | tr -d " \n" `# Elimina espacios y newlines sobrantes`)

    # Creamos el sistema de ficheros
    echo "Creando sistema de ficheros en $FAT_PARTITION"
    # fat32 es vfat
    mkfs.vfat $FAT_PARTITION

    # Creamos el punto de montaje y montamos
    echo "Montando $FAT_PARTITION en $MOUNT_POINT"
    mount $FAT_PARTITION "$MOUNT_POINT"
}

mkdir /data1
mkdir /data2
mkdir /data3

create_fat_partition "/dev/sda" "/data1"

# Obtenemos el uuid de la particion que acabamos de crear
FAT_PART_UUID=$(blkid -s UUID -o value $FAT_PARTITION)

# Actualizamos fstab
echo "UUID=$FAT_PART_UUID /data1 vfat defaults 0 0" >> /etc/fstab

# Añadimos las otras dos particiones del segundo disco, creadas desde su
# respectivo sistema operativo
# mount -t ufs -o ro /dev/sdb1 /data2
echo "/dev/sdb1 /data2 ufs ro 0 0" >> /etc/fstab

```

### Solaris 10
<!--
format
1 disco 1
fdisk 
se queja de que no existe tabla de particiones, no queremos usar todo solaris: n

1. Create a partition
1=SOLARIS2
Como sabemos que el disco es de 1Gb y queremos utilizar la mitad, especificamos 50%.
Alternativamente podemos calcular los cilindros a mano, utilizando los datos que muestra
por pantalla en el paso anterior.
Active partition? No
5. Exit
partition
print
format>quit
-->
```bash
#!/bin/bash

set -e

# touch /reconfigure # Para que detecte dispositivos nuevos al reiniciar
# Para actualizar sin evitar reinicio
devfsadm -C -c disk -v
devfsadm -c disk -v

# TODO: automatizar "partition" y obtener UFS_DISK

UFS_DISK="c0t1d0s2"

newfs /dev/rdsk/$UFS_DISK <<< "y"
fsck /dev/rdsk/$UFS_DISK

mkdir /data1
mkdir /data2
mkdir /data3

mount /dev/dsk/c0t1d0s2 /data2

# Opciones de montaje: man mount_ufs
# mount dev | fsck dev | mountpoint | type | fsck pass | mount at boot | options
echo "/dev/dsk/$UFS_DISK  /dev/rdsk/$UFS_DISK  /data2  ufs  3  yes  -" >> /etc/vfstab

```

### OpenBSD 6.8
Añadimos la partición FAT al disklabel en el primer disco. En nuestro caso,
OpenBSD ya la añade automáticamente. Si no fuese así, se puede hacer de forma
manual:


Primero comprobamos el tamaño con `fdisk sd0`.
Editamos el disklabel con `disklabel -e sd0` y añadimos:
```bash
k: <size de fdisk> <offset de fdisk> MSDOS
```


Para crear una partición de OpenBSD formateada con *ffs*:
Tenemos que crear primero la partición en el *MBR* con `fdisk sd1`.
A continuación, tenemos que añadirla al disklabel con `disklabel -e sd1`,
por último formatearla y montarla. Hemos automatizado la creación en el siguiente
script:

```bash
#!/bin/ksh
set -e

DISK="sd1"

DISKINFO=`fdisk $DISK`

# Obtiene los sectores totales del disco de fdisk
TOTAL_SECTORS=`echo "$DISKINFO" | grep -e "[0-9]* Sectors]" -o | cut -d " " -f 1`

# Obtiene el offset y size de la particion de Solaris
SOLARIS_PARTITION=`echo "$DISKINFO" | grep -e "[0-3]: BF" | cut -d "[" -f 2`
SOLARIS_OFFSET=`echo $SOLARIS_PARTITION | cut -d ":" -f 1 | tr -d " "`
SOLARIS_SIZE=`echo $SOLARIS_PARTITION | cut -d ":" -f 2 | cut -d "]" -f 1 | tr -d " "`

# Calculamos el offset de la nueva particion
let OFFSET=$SOLARIS_OFFSET+$SOLARIS_SIZE+1

# Calculamos el tamaño de la nueva particion
let SIZE=$TOTAL_SECTORS-$OFFSET

echo "Offset: $OFFSET"
echo "Tamano: $SIZE"

printf "\
edit 1\n\
A6\n\
n\n\
$OFFSET\n\
$SIZE\n\
write\n\
quit" \
| fdisk -e $DISK

```

Editamos el disklabel `disklabel -e sd1` y añadimos (utilizando los tamaños fsize/bsize/cpg recomendados):
```bash
  d:  <tamano del script> <offset del script> 4.2BSD 2048 16384 16
```

Creamos el sistema de ficheros y configuramos puntos de montaje de las tres particiones:
```bash
#!/bin/ksh
set -e

# Creamos sistema de ficheros
newfs /dev/rsd1d

# Creamos puntos de montaje
mkdir /data1
mkdir /data3

# Montamos
mount /dev/sd0k /data1
mount /dev/sd1d /data3

# Obtenemos el id del disklabel
DID1=`disklabel sd0 | grep "duid" | cut -d ":" -f 2 | tr -d ' '`
DID2=`disklabel sd1 | grep "duid" | cut -d ":" -f 2 | tr -d ' '`
# Anadimos a fstab para montar en el arranque
echo "$DID1.k /data1 msdos rw,nodev,nosuid 1 3  yes  -" >> /etc/fstab
echo "$DID2.d /data3 ffs rw,nodev,nosuid 1 3  yes  -" >> /etc/fstab
```


## MAQUINA 2
### VirtualBox
Añadimos el disco a la máquina ASO2:
- Configuración
  - Almacenamiento
    - Controlador: IDE -> Agregar
      - Crear
        - Modo experto
          - Tamaño de archivo *4,00 GB*
          - Tipo de archivo de disco duro *VMDK (Virtual Machine Disk)*
          - Almacenamiento en disco duro *Reservado dinámicamente*
      - Seleccionamos *ASO2_1.vmdk*
      - Seleccionar
  - Aceptar

El resultado debería ser

![Dispositivos de almacenamiento en ASO2](./img/hdd_aso2.png)
### FreeBSD
Comenzaremos primero por FreeBSD.

Instalamos gdisk para editar la tabla de particiones:
```bash
pkg install -y gdisk
```

Tras esto ejecutamos
```bash
gdisk /dev/ada1
```
y procedemos con los siguientes inputs
- **o** (**Y**es)
- **n**
  - \<ENTER\> (Partition number 1)
  - \<ENTER\> (First sector 2048)
  - +2GB
  - \<ENTER\> (A503 FreeBSD UFS)
- **n**
  - \<ENTER\> (Partition number 2)
  - \<ENTER\> (First sector 4196352)
  - \<ENTER\> (Last sector 8388574)
  - 8300 (Linux filesystem)
- **w** (**Y**es)
  
Ante el aviso que nos arroja ejecutamos
```bash
reboot
```

Tras reiniciar, ya se nos debería auto crear los archivos `/dev/ada1p1` y `/dev/ada1p2`. El primero lo formatearemos en FreeBSD UFS.
```bash
newfs /dev/ada1p1
```

Tras esto volvemos a reiniciar, esta vez a fedora, ya que por el momento, hemos terminado.

### Fedora
TEST

## MAQUINA 3
### Solaris 11

### Ubuntu
